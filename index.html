<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï</title>
    
    <!-- External Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: #3b82f6; }
        
        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .entry-row:hover .swipe-actions {
            transform: translateX(0);
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                z-index: 1000;
            }
            
            .dark .mobile-nav {
                background: #1f2937;
                border-top-color: #374151;
            }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sync-status.synced {
            background: #dcfce7;
            color: #166534;
        }
        
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .sync-status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .sync-status.offline {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* Print styles for PDF export */
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page-container {
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            
            .mobile-nav,
            .floating-buttons {
                display: none !important;
            }
        }

        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #718096;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2d3748;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            color: #718096;
        }

        .auth-toggle button {
            color: #667eea;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
        }

        .filtered-summary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filtered-summary h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filtered-summary .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .filtered-summary .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .filtered-summary .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .filtered-summary .stat-value {
            font-size: 1rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï</h1>
                <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</p>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>

            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                    <input type="email" id="email" class="form-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
                </div>
                
                <div class="form-group">
                    <label for="password">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="password" class="form-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
                </div>
                
                <button type="submit" id="loginBtn" class="btn-primary">
                    <span id="loginBtnText">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    <div id="loginSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>

            <div class="auth-toggle">
                <p>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü? <button type="button" id="showRegister">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button></p>
            </div>

            <!-- Register Form -->
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="regEmail">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                    <input type="email" id="regEmail" class="form-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
                </div>
                
                <div class="form-group">
                    <label for="regPassword">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required>
                </div>
                
                <button type="submit" id="registerBtn" class="btn-primary">
                    <span id="registerBtnText">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    <div id="registerSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>

            <div id="registerToggle" class="auth-toggle hidden">
                <p>‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <button type="button" id="showLogin">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button></p>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600 dark:text-gray-300">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="min-h-screen pb-20 md:pb-0 hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-wallet text-3xl text-blue-500 mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- User Info -->
                        <div class="flex items-center space-x-2">
                            <span id="userEmail" class="text-sm text-gray-600 dark:text-gray-300"></span>
                            <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800 dark:text-red-400">
                                <i class="fas fa-sign-out-alt mr-1"></i>‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
                            </button>
                        </div>
                        
                        <!-- Firebase Sync Status -->
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-database"></i>
                            <span>‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</span>
                        </div>
                        
                        <!-- Theme Toggle -->
                        <button id="themeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sun dark:hidden"></i>
                            <i class="fas fa-moon hidden dark:inline"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</p>
                            <p class="text-2xl font-bold" id="totalIncome">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-arrow-up text-3xl text-green-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-red-400 to-red-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                            <p class="text-2xl font-bold" id="totalExpense">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-arrow-down text-3xl text-red-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                            <p class="text-2xl font-bold" id="currentBalance">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-wallet text-3xl text-blue-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</p>
                            <p class="text-2xl font-bold" id="totalEntries">‡ß¶</p>
                        </div>
                        <i class="fas fa-list text-3xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <!-- Book Management -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-book mr-2"></i>‡¶¨‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
                </h3>
                
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <select id="currentBook" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                    
                    <div class="flex gap-2">
                        <button id="createBookBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á
                        </button>
                        <button id="deleteBookBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-trash mr-1"></i>‡¶¨‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Entry Form -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </h3>
                
                <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="entryDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ß‡¶∞‡¶®</label>
                        <select id="entryType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            <option value="income">‡¶Ü‡¶Ø‡¶º</option>
                            <option value="expense">‡¶ñ‡¶∞‡¶ö</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                        <input type="number" id="entryAmount" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡ß¶" min="0" step="0.01" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø</label>
                        <select id="entryCategory" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶®‡ßã‡¶ü</label>
                        <input type="text" id="entryNote" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
                    </div>
                    
                    <div class="md:col-span-3">
                        <div class="flex gap-4">
                            <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                            <button type="button" id="cancelEditBtn" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors hidden">
                                <i class="fas fa-times mr-2"></i>‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-filter mr-2"></i>‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
                </h3>

                <!-- Filtered Summary -->
                <div id="filteredSummary" class="hidden"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="filterStartDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="filterEndDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ß‡¶∞‡¶®</label>
                        <select id="filterType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">‡¶∏‡¶¨</option>
                            <option value="income">‡¶Ü‡¶Ø‡¶º</option>
                            <option value="expense">‡¶ñ‡¶∞‡¶ö</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø</label>
                        <select id="filterCategory" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">‡¶∏‡¶¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchBox" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶®‡ßã‡¶ü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®...">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="applyFiltersBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-search mr-1"></i>‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-eraser mr-1"></i>‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 no-print">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-download mr-2"></i>‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶®
                </h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="exportPdfBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-file-pdf mr-1"></i>PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                    </button>
                    <button id="exportCsvBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-file-csv mr-1"></i>CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                    </button>
                </div>
            </div>

            <!-- Entries Table -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                            <i class="fas fa-list mr-2"></i>‡¶∏‡¶¨ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø
                        </h3>
                        
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-500 dark:text-gray-400" id="entriesCount">‡ß¶‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</span>
                            
                            <div class="flex gap-2 no-print">
                                <button id="selectAllBtn" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors">
                                    ‡¶∏‡¶¨ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®
                                </button>
                                <button id="deleteSelectedBtn" class="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                                    ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">
                                    <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('date')">
                                    ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶¶‡¶ø‡¶®
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('type')">
                                    ‡¶ß‡¶∞‡¶® <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('amount')">
                                    ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶®‡ßã‡¶ü
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">
                                    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®
                                </th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Entries will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav md:hidden">
            <div class="flex justify-around items-center py-2">
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('summary')">
                    <i class="fas fa-chart-bar text-lg"></i>
                    <span class="text-xs mt-1">‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('addEntry')">
                    <i class="fas fa-plus-circle text-lg"></i>
                    <span class="text-xs mt-1">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('entries')">
                    <i class="fas fa-list text-lg"></i>
                    <span class="text-xs mt-1">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('export')">
                    <i class="fas fa-download text-lg"></i>
                    <span class="text-xs mt-1">‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-buttons fixed right-6 bottom-24 md:bottom-6 z-20 no-print">
        <button id="fab" class="w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 transform hover:scale-110">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <!-- Modals -->
    <!-- Create Book Modal -->
    <div id="createBookModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 animate-slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="closeModal('createBookModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="createBookForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="newBookName" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ñ‡¶∞‡¶ö" required>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                        <button type="button" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors" onclick="closeModal('createBookModal')">
                            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 animate-slide-up">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                </div>
                
                <p class="text-gray-600 dark:text-gray-300 mb-6" id="confirmMessage">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?</p>
                
                <div class="flex gap-4">
                    <button id="confirmYes" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                        ‡¶π‡ßç‡¶Ø‡¶æ‡¶Å
                    </button>
                    <button id="confirmNo" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                        ‡¶®‡¶æ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBfScJbFejegAjUfQdse6v85FmsIUOiAHY",
            authDomain: "mycashbookapp-7cb8f.firebaseapp.com",
            databaseURL: "https://mycashbookapp-7cb8f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mycashbookapp-7cb8f",
            storageBucket: "mycashbookapp-7cb8f.firebasestorage.app",
            messagingSenderId: "440406592404",
            appId: "1:440406592404:web:02b65b90d195c9baa5dd81",
            measurementId: "G-QYNR6RL6PS"
        };

        // Initialize Firebase
        let app, analytics, db, auth;
        
        // Global variables
        let currentUser = null;
        let currentBookId = null;
        let entries = [];
        let books = [];
        let editingEntryId = null;
        let sortColumn = 'date';
        let sortDirection = 'desc';

        // Categories
        const categories = {
            income: ['‡¶¨‡ßá‡¶§‡¶®', '‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ', '‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', '‡¶â‡¶™‡¶π‡¶æ‡¶∞', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ü‡¶Ø‡¶º'],
            expense: ['‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø', '‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®', '‡¶¨‡¶ø‡¶®‡ßã‡¶¶‡¶®', '‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø', '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', '‡¶¨‡¶ø‡¶≤', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö']
        };

        // Days of week in Bengali
        const bengaliDays = ['‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            setupAuthListeners();
            setupEventListeners();
            loadThemePreference();
        });

        function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                auth = firebase.auth();
                analytics = firebase.analytics(app);
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showToast('Firebase ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ', 'error');
            }
        }

        function setupAuthListeners() {
            // Login/Register form toggles
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Auth state observer
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    document.getElementById('userEmail').textContent = user.email;
                    showLoadingScreen();
                    loadUserDataFromFirebase(user.uid);
                } else {
                    showLoginSection();
                }
            });
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('showRegister').parentElement.classList.remove('hidden');
            document.getElementById('registerToggle').classList.add('hidden');
            hideMessages();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('showRegister').parentElement.classList.add('hidden');
            document.getElementById('registerToggle').classList.remove('hidden');
            hideMessages();
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showErrorMessage('‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
                return;
            }
            
            setLoading('loginBtn', 'loginBtnText', 'loginSpinner', true);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showSuccessMessage('‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                    // Auth state change will handle the rest
                })
                .catch((error) => {
                    setLoading('loginBtn', 'loginBtnText', 'loginSpinner', false);
                    showErrorMessage(getErrorMessage(error.code));
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showErrorMessage('‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');
                return;
            }
            
            if (password !== confirmPassword) {
                showErrorMessage('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ');
                return;
            }
            
            if (password.length < 6) {
                showErrorMessage('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá');
                return;
            }
            
            setLoading('registerBtn', 'registerBtnText', 'registerSpinner', true);
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showSuccessMessage('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                    // Auth state change will handle the rest
                })
                .catch((error) => {
                    setLoading('registerBtn', 'registerBtnText', 'registerSpinner', false);
                    showErrorMessage(getErrorMessage(error.code));
                });
        }

        function handleLogout() {
            auth.signOut()
                .then(() => {
                    showToast('‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶∏‡¶´‡¶≤', 'success');
                })
                .catch((error) => {
                    showToast('‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ', 'error');
                });
        }

        function setLoading(btnId, textId, spinnerId, isLoading) {
            const btn = document.getElementById(btnId);
            const text = document.getElementById(textId);
            const spinner = document.getElementById(spinnerId);
            
            if (isLoading) {
                btn.disabled = true;
                text.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                btn.disabled = false;
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        function getErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': '‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á',
                'auth/wrong-password': '‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°',
                'auth/email-already-in-use': '‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§',
                'auth/weak-password': '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ñ‡ßÅ‡¶¨ ‡¶∏‡¶π‡¶ú',
                'auth/invalid-email': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º',
                'auth/too-many-requests': '‡¶Ö‡¶®‡ßá‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®, ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®'
            };
            return messages[errorCode] || '‡¶ï‡ßã‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
        }

        function showLoginSection() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function showLoadingScreen() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function showAppContainer() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
        }

        function loadUserDataFromFirebase(uid) {
            updateSyncStatus('syncing', '‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
            
            db.ref('users/' + uid + '/cashbook').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        books = data.books || [];
                        entries = data.entries || [];
                        currentBookId = data.currentBookId || null;
                        updateSyncStatus('synced', 'Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶°');
                    } else {
                        // Create default data for new user
                        books = [{ id: Date.now().toString(), name: '‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡¶á', createdAt: new Date().toISOString() }];
                        currentBookId = books[0].id;
                        entries = [];
                        saveUserDataToFirebase();
                    }
                    
                    // Also save to localStorage for offline access
                    saveUserDataToLocal();
                    initializeApp();
                })
                .catch(error => {
                    console.error('Error loading data from Firebase:', error);
                    updateSyncStatus('error', '‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
                    // Try to load from localStorage
                    loadUserDataFromLocal();
                    initializeApp();
                });
        }

        function saveUserDataToFirebase() {
            if (!currentUser) return;
            
            updateSyncStatus('syncing', '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
            
            const data = {
                books: books,
                entries: entries,
                currentBookId: currentBookId,
                lastUpdated: new Date().toISOString()
            };
            
            db.ref('users/' + currentUser.uid + '/cashbook').set(data)
                .then(() => {
                    updateSyncStatus('synced', 'Firebase ‡¶è ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§');
                })
                .catch(error => {
                    console.error('Error saving to Firebase:', error);
                    updateSyncStatus('error', '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
                });
        }

        function loadUserDataFromLocal() {
            const userData = safeGetLocalStorage('cashbook_data');
            if (userData) {
                books = userData.books || [];
                entries = userData.entries || [];
                currentBookId = userData.currentBookId || null;
            } else {
                // Create default book
                books = [{ id: Date.now().toString(), name: '‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡¶á', createdAt: new Date().toISOString() }];
                currentBookId = books[0].id;
                entries = [];
            }
        }

        function saveUserDataToLocal() {
            const data = {
                books: books,
                entries: entries,
                currentBookId: currentBookId
            };
            safeSetLocalStorage('cashbook_data', data);
        }

        function saveUserData() {
            saveUserDataToLocal();
            if (currentUser) {
                saveUserDataToFirebase();
            } else {
                updateSyncStatus('offline', '‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§');
            }
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Entry form
            document.getElementById('entryForm').addEventListener('submit', handleAddEntry);
            document.getElementById('entryType').addEventListener('change', updateCategoryOptions);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
            
            // Book management
            document.getElementById('createBookBtn').addEventListener('click', () => openModal('createBookModal'));
            document.getElementById('deleteBookBtn').addEventListener('click', deleteCurrentBook);
            document.getElementById('currentBook').addEventListener('change', switchBook);
            document.getElementById('createBookForm').addEventListener('submit', handleCreateBook);
            
            // Filters
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('searchBox').addEventListener('input', applyFilters);
            
            // Filter inputs for auto-apply
            document.getElementById('filterStartDate').addEventListener('change', applyFilters);
            document.getElementById('filterEndDate').addEventListener('change', applyFilters);
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('filterCategory').addEventListener('change', applyFilters);
            
            // Export buttons
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
            
            // Table actions
            document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAll);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedEntries);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            
            // Floating action button
            document.getElementById('fab').addEventListener('click', () => {
                document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('entryAmount').focus();
            });
            
            // Confirmation modal
            document.getElementById('confirmYes').addEventListener('click', confirmAction);
            document.getElementById('confirmNo').addEventListener('click', () => closeModal('confirmModal'));
            
            // Set default date
            document.getElementById('entryDate').valueAsDate = new Date();
        }

        function initializeApp() {
            setTimeout(() => {
                updateBookSelector();
                updateSummary();
                renderEntries();
                showAppContainer();
            }, 1000);
        }

        // Safe localStorage operations
        function safeGetLocalStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error(`Error reading from localStorage (${key}):`, error);
                return defaultValue;
            }
        }

        function safeSetLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.error(`Error writing to localStorage (${key}):`, error);
                showToast('‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
                return false;
            }
        }

        function safeGetStringFromLocalStorage(key, defaultValue = null) {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (error) {
                console.error(`Error reading string from localStorage (${key}):`, error);
                return defaultValue;
            }
        }

        function safeSetStringToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.error(`Error writing string to localStorage (${key}):`, error);
                return false;
            }
        }

        function updateSyncStatus(status, text) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.className = `sync-status ${status}`;
            
            const icons = {
                synced: 'fa-check-circle',
                syncing: 'fa-sync-alt fa-spin',
                error: 'fa-exclamation-triangle',
                offline: 'fa-database'
            };
            
            syncStatus.innerHTML = `
                <i class="fas ${icons[status]}"></i>
                <span>${text}</span>
            `;
        }

        function updateBookSelector() {
            const selector = document.getElementById('currentBook');
            selector.innerHTML = '<option value="">‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                if (book.id === currentBookId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            updateCategoryOptions();
        }

        function switchBook() {
            const newBookId = document.getElementById('currentBook').value;
            if (newBookId !== currentBookId) {
                currentBookId = newBookId;
                saveUserData();
                updateSummary();
                renderEntries();
                showToast('‡¶¨‡¶á ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            }
        }

        function handleCreateBook(e) {
            e.preventDefault();
            
            const bookName = document.getElementById('newBookName').value.trim();
            if (!bookName) {
                showToast('‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error');
                return;
            }
            
            const newBook = {
                id: Date.now().toString(),
                name: bookName,
                createdAt: new Date().toISOString()
            };
            
            books.push(newBook);
            currentBookId = newBook.id;
            saveUserData();
            updateBookSelector();
            closeModal('createBookModal');
            
            showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            
            document.getElementById('newBookName').value = '';
        }

        function deleteCurrentBook() {
            if (!currentBookId) {
                showToast('‡¶ï‡ßã‡¶® ‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º', 'error');
                return;
            }
            
            if (books.length <= 1) {
                showToast('‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶á ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
                return;
            }
            
            const currentBook = books.find(b => b.id === currentBookId);
            showConfirmModal(
                `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${currentBook.name}" ‡¶¨‡¶á‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶§‡ßá ‡¶∏‡¶¨ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`,
                () => {
                    // Remove book and its entries
                    books = books.filter(b => b.id !== currentBookId);
                    entries = entries.filter(e => e.bookId !== currentBookId);
                    
                    // Switch to first available book
                    currentBookId = books[0].id;
                    
                    saveUserData();
                    updateBookSelector();
                    updateSummary();
                    renderEntries();
                    
                    showToast('‡¶¨‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                }
            );
        }

        function updateCategoryOptions() {
            const typeSelect = document.getElementById('entryType');
            const categorySelect = document.getElementById('entryCategory');
            const filterCategorySelect = document.getElementById('filterCategory');
            
            const selectedType = typeSelect.value;
            
            // Clear and populate category options
            categorySelect.innerHTML = '<option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            filterCategorySelect.innerHTML = '<option value="">‡¶∏‡¶¨</option>';
            
            if (selectedType && categories[selectedType]) {
                categories[selectedType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                    
                    const filterOption = option.cloneNode(true);
                    filterCategorySelect.appendChild(filterOption);
                });
            }
        }

        function handleAddEntry(e) {
            e.preventDefault();
            
            if (!currentBookId) {
                showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }
            
            const formData = {
                date: document.getElementById('entryDate').value,
                type: document.getElementById('entryType').value,
                amount: parseFloat(document.getElementById('entryAmount').value),
                category: document.getElementById('entryCategory').value,
                note: document.getElementById('entryNote').value.trim()
            };
            
            // Validation
            if (!formData.date || !formData.type || !formData.amount || !formData.category) {
                showToast('‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }
            
            if (formData.amount <= 0) {
                showToast('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß¶ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
                return;
            }
            
            const entry = {
                id: editingEntryId || Date.now().toString(),
                bookId: currentBookId,
                date: formData.date,
                type: formData.type,
                amount: formData.amount,
                category: formData.category,
                note: formData.note,
                createdAt: editingEntryId ? entries.find(e => e.id === editingEntryId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingEntryId) {
                // Update existing entry
                const index = entries.findIndex(e => e.id === editingEntryId);
                entries[index] = entry;
                showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                cancelEdit();
            } else {
                // Add new entry
                entries.push(entry);
                showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            }
            
            saveUserData();
            updateSummary();
            renderEntries();
            
            // Reset form
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
        }

        function editEntry(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;
            
            editingEntryId = entryId;
            
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryType').value = entry.type;
            document.getElementById('entryAmount').value = entry.amount;
            document.getElementById('entryNote').value = entry.note;
            
            // Update category options and set selected
            updateCategoryOptions();
            setTimeout(() => {
                document.getElementById('entryCategory').value = entry.category;
            }, 100);
            
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡ßá', 'info');
        }

        function cancelEdit() {
            editingEntryId = null;
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            updateCategoryOptions();
        }

        function deleteEntry(entryId) {
            showConfirmModal(
                '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
                () => {
                    entries = entries.filter(e => e.id !== entryId);
                    saveUserData();
                    updateSummary();
                    renderEntries();
                    showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                }
            );
        }

        function getCurrentBookEntries() {
            return entries.filter(e => e.bookId === currentBookId);
        }

        function updateSummary() {
            const bookEntries = getCurrentBookEntries();
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            bookEntries.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            const totalEntries = bookEntries.length;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('currentBalance').textContent = formatCurrency(balance);
            document.getElementById('totalEntries').textContent = totalEntries.toString();
            
            // Update balance color
            const balanceElement = document.getElementById('currentBalance');
            const balanceCard = balanceElement.closest('.bg-gradient-to-r');
            
            if (balance > 0) {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-green-400 to-green-600');
            } else if (balance < 0) {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-red-400 to-red-600');
            } else {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-blue-400 to-blue-600');
            }
        }

        function updateFilteredSummary() {
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredEntries.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            const summaryBox = document.getElementById('filteredSummary');
            
            // Check if any filters are applied
            const hasFilters = document.getElementById('filterStartDate').value ||
                              document.getElementById('filterEndDate').value ||
                              document.getElementById('filterType').value ||
                              document.getElementById('filterCategory').value ||
                              document.getElementById('searchBox').value.trim();
            
            if (hasFilters && filteredEntries.length !== bookEntries.length) {
                summaryBox.innerHTML = `
                    <div class="filtered-summary">
                        <h4>
                            <i class="fas fa-filter"></i>
                            ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ (${filteredEntries.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø)
                        </h4>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                                <div class="stat-value">${formatCurrency(totalIncome)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</div>
                                <div class="stat-value">${formatCurrency(totalExpense)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                                <div class="stat-value ${balance >= 0 ? 'text-green-200' : 'text-red-200'}">${formatCurrency(balance)}</div>
                            </div>
                        </div>
                    </div>
                `;
                summaryBox.classList.remove('hidden');
            } else {
                summaryBox.classList.add('hidden');
            }
        }

        function renderEntries() {
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            const sortedEntries = sortEntriesList(filteredEntries, sortColumn, sortDirection);
            
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            if (sortedEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            <p class="text-lg">‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>
                            <p class="text-sm">‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </td>
                    </tr>
                `;
                document.getElementById('entriesCount').textContent = '‡ß¶‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø';
                return;
            }
            
            sortedEntries.forEach(entry => {
                const date = new Date(entry.date);
                const dayName = bengaliDays[date.getDay()];
                const typeClass = entry.type === 'income' ? 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300' : 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300';
                
                const row = document.createElement('tr');
                row.className = 'entry-row hover:bg-gray-50 dark:hover:bg-gray-700 relative';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap no-print">
                        <input type="checkbox" class="entry-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" data-entry-id="${entry.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        ${formatDate(entry.date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${dayName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeClass}">
                            <i class="fas fa-${entry.type === 'income' ? 'arrow-up' : 'arrow-down'} mr-1"></i>
                            ${entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${entry.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                        ${formatCurrency(entry.amount)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        ${entry.category}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate" title="${entry.note}">
                        ${entry.note || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium no-print">
                        <div class="flex space-x-2">
                            <button onclick="editEntry('${entry.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEntry('${entry.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('entriesCount').textContent = `${sortedEntries.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø`;
            
            // Update filtered summary
            updateFilteredSummary();
        }

        function applyCurrentFilters(entries) {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const category = document.getElementById('filterCategory').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            return entries.filter(entry => {
                if (startDate && entry.date < startDate) return false;
                if (endDate && entry.date > endDate) return false;
                if (type && entry.type !== type) return false;
                if (category && entry.category !== category) return false;
                if (searchTerm && !entry.note.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
        }

        function applyFilters() {
            renderEntries();
        }

        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('searchBox').value = '';
            applyFilters();
        }

        function sortEntriesList(entries, column, direction) {
            return [...entries].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (column === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else if (column === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        window.sortEntries = function(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderEntries();
        };

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const entryCheckboxes = document.querySelectorAll('.entry-checkbox');
            
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function deleteSelectedEntries() {
            const selectedCheckboxes = document.querySelectorAll('.entry-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º', 'warning');
                return;
            }
            
            showConfirmModal(
                `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${selectedCheckboxes.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`,
                () => {
                    const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.entryId);
                    entries = entries.filter(entry => !idsToDelete.includes(entry.id));
                    
                    saveUserData();
                    updateSummary();
                    renderEntries();
                    
                    showToast(`${selectedCheckboxes.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                }
            );
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add Bengali font support
            const bengaliFont = 'NotoSansBengali';
            
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredEntries.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // Add content to PDF with better Bengali support
            doc.setFontSize(20);
            doc.text('‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD')}`, 20, 35);
            
            const currentBook = books.find(b => b.id === currentBookId);
            if (currentBook) {
                doc.text(`‡¶¨‡¶á: ${currentBook.name}`, 20, 45);
            }
            
            // Check if filtered
            const hasFilters = document.getElementById('filterStartDate').value ||
                              document.getElementById('filterEndDate').value ||
                              document.getElementById('filterType').value ||
                              document.getElementById('filterCategory').value ||
                              document.getElementById('searchBox').value.trim();
            
            if (hasFilters) {
                doc.text('‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶°‡¶æ‡¶ü‡¶æ', 20, 55);
            }
            
            // Summary
            doc.setFontSize(16);
            doc.text('‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂:', 20, 70);
            
            doc.setFontSize(12);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º: ${formatCurrency(totalIncome)}`, 20, 85);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: ${formatCurrency(totalExpense)}`, 20, 95);
            doc.text(`‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${formatCurrency(balance)}`, 20, 105);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø: ${filteredEntries.length}`, 20, 115);
            
            // Entries table
            if (filteredEntries.length > 0) {
                doc.setFontSize(16);
                doc.text('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:', 20, 135);
                
                let yPos = 150;
                doc.setFontSize(9);
                
                // Table header
                doc.text('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', 20, yPos);
                doc.text('‡¶ß‡¶∞‡¶®', 55, yPos);
                doc.text('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£', 80, yPos);
                doc.text('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø', 120, yPos);
                doc.text('‡¶®‡ßã‡¶ü', 160, yPos);
                
                yPos += 10;
                
                // Add line under header
                doc.line(20, yPos - 2, 190, yPos - 2);
                
                filteredEntries.forEach(entry => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                        
                        // Add header on new page
                        doc.setFontSize(9);
                        doc.text('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', 20, yPos);
                        doc.text('‡¶ß‡¶∞‡¶®', 55, yPos);
                        doc.text('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£', 80, yPos);
                        doc.text('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø', 120, yPos);
                        doc.text('‡¶®‡ßã‡¶ü', 160, yPos);
                        yPos += 10;
                        doc.line(20, yPos - 2, 190, yPos - 2);
                    }
                    
                    doc.text(formatDate(entry.date), 20, yPos);
                    doc.text(entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö', 55, yPos);
                    doc.text(formatCurrency(entry.amount), 80, yPos);
                    doc.text(entry.category, 120, yPos);
                    doc.text((entry.note || '-').substring(0, 25), 160, yPos);
                    
                    yPos += 8;
                });
            }
            
            // Generate filename
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = hasFilters ? 
                `cashbook-filtered-${dateStr}.pdf` : 
                `cashbook-report-${dateStr}.pdf`;
            
            doc.save(filename);
            showToast('PDF ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function exportToCSV() {
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            
            if (filteredEntries.length === 0) {
                showToast('‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á', 'warning');
                return;
            }
            
            // Add BOM for proper Bengali encoding
            const BOM = '\uFEFF';
            const headers = ['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', '‡¶ß‡¶∞‡¶®', '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£', '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø', '‡¶®‡ßã‡¶ü'];
            const csvContent = [
                headers.join(','),
                ...filteredEntries.map(entry => [
                    entry.date,
                    entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö',
                    entry.amount,
                    entry.category,
                    `"${entry.note || ''}"`
                ].join(','))
            ].join('\n');
            
            // Check if filtered
            const hasFilters = document.getElementById('filterStartDate').value ||
                              document.getElementById('filterEndDate').value ||
                              document.getElementById('filterType').value ||
                              document.getElementById('filterCategory').value ||
                              document.getElementById('searchBox').value.trim();
            
            const filename = hasFilters ? 
                `cashbook-filtered-${new Date().toISOString().split('T')[0]}.csv` : 
                `cashbook-${new Date().toISOString().split('T')[0]}.csv`;
            
            downloadFile(BOM + csvContent, filename, 'text/csv;charset=utf-8');
            showToast('CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Theme management
        function loadThemePreference() {
            const savedTheme = safeGetStringFromLocalStorage('cashbook_theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            safeSetStringToLocalStorage('cashbook_theme', isDark ? 'dark' : 'light');
            showToast(`${isDark ? '‡¶°‡¶æ‡¶∞‡ßç‡¶ï' : '‡¶≤‡¶æ‡¶á‡¶ü'} ‡¶•‡¶ø‡¶Æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'info');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmYes').onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        }

        function confirmAction() {
            // This will be overridden by showConfirmModal
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${getToastIcon(type)} mr-2"></i>
                ${message}
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Mobile navigation
        function scrollToSection(section) {
            const sections = {
                summary: document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4'),
                addEntry: document.getElementById('entryForm'),
                entries: document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.shadow-lg.overflow-hidden'),
                export: document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.shadow-lg.p-6.mb-8.no-print')
            };
            
            if (sections[section]) {
                sections[section].scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('bn-BD', {
                style: 'currency',
                currency: 'BDT',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount).replace('‡ß≥', '') + ' ‡ß≥';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('bn-BD', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Auto-save functionality
        setInterval(() => {
            if (currentBookId && currentUser) {
                saveUserData();
            }
        }, 30000); // Auto-save every 30 seconds
    </script>
</body>
</html>
