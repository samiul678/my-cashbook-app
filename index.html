<!DOCTYPE html>
<html lang="bn">
<head>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï</title>
    
    <!-- External Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: #3b82f6; }
        
        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .entry-row:hover .swipe-actions {
            transform: translateX(0);
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                z-index: 1000;
            }
            
            .dark .mobile-nav {
                background: #1f2937;
                border-top-color: #374151;
            }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sync-status.synced {
            background: #dcfce7;
            color: #166534;
        }
        
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .sync-status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .sync-status.offline {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* Print styles for PDF export */
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page-container {
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            
            .mobile-nav,
            .floating-buttons {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600 dark:text-gray-300">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="min-h-screen pb-20 md:pb-0 hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-wallet text-3xl text-blue-500 mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Google Drive Sync Status -->
                        <div id="syncStatus" class="sync-status offline">
                            <i class="fas fa-cloud-off"></i>
                            <span>‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®</span>
                        </div>
                        
                        <!-- Google Drive Sync Button -->
                        <button id="syncBtn" class="p-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition-colors" title="Google Drive ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        
                        <!-- Theme Toggle -->
                        <button id="themeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sun dark:hidden"></i>
                            <i class="fas fa-moon hidden dark:inline"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</p>
                            <p class="text-2xl font-bold" id="totalIncome">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-arrow-up text-3xl text-green-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-red-400 to-red-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                            <p class="text-2xl font-bold" id="totalExpense">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-arrow-down text-3xl text-red-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                            <p class="text-2xl font-bold" id="currentBalance">‡ß¶ ‡ß≥</p>
                        </div>
                        <i class="fas fa-wallet text-3xl text-blue-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-xl p-6 text-white animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</p>
                            <p class="text-2xl font-bold" id="totalEntries">‡ß¶</p>
                        </div>
                        <i class="fas fa-list text-3xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <!-- Book Management -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-book mr-2"></i>‡¶¨‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
                </h3>
                
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <select id="currentBook" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                    
                    <div class="flex gap-2">
                        <button id="createBookBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus mr-1"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á
                        </button>
                        <button id="deleteBookBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-trash mr-1"></i>‡¶¨‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Entry Form -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                    <i class="fas fa-plus-circle mr-2"></i>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </h3>
                
                <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="entryDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ß‡¶∞‡¶®</label>
                        <select id="entryType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            <option value="income">‡¶Ü‡¶Ø‡¶º</option>
                            <option value="expense">‡¶ñ‡¶∞‡¶ö</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                        <input type="number" id="entryAmount" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡ß¶" min="0" step="0.01" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø</label>
                        <select id="entryCategory" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" required>
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶®‡ßã‡¶ü</label>
                        <input type="text" id="entryNote" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
                    </div>
                    
                    <div class="md:col-span-3">
                        <div class="flex gap-4">
                            <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                            <button type="button" id="cancelEditBtn" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors hidden">
                                <i class="fas fa-times mr-2"></i>‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-filter mr-2"></i>‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="filterStartDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="filterEndDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ß‡¶∞‡¶®</label>
                        <select id="filterType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">‡¶∏‡¶¨</option>
                            <option value="income">‡¶Ü‡¶Ø‡¶º</option>
                            <option value="expense">‡¶ñ‡¶∞‡¶ö</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø</label>
                        <select id="filterCategory" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">‡¶∏‡¶¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchBox" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶®‡ßã‡¶ü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®...">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="applyFiltersBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-search mr-1"></i>‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-eraser mr-1"></i>‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 no-print">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-download mr-2"></i>‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶®
                </h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="exportPdfBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-file-pdf mr-1"></i>PDF
                    </button>
                    <button id="exportCsvBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-file-csv mr-1"></i>CSV
                    </button>
                </div>
            </div>

            <!-- Entries Table -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                            <i class="fas fa-list mr-2"></i>‡¶∏‡¶¨ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø
                        </h3>
                        
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-500 dark:text-gray-400" id="entriesCount">‡ß¶‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</span>
                            
                            <div class="flex gap-2 no-print">
                                <button id="selectAllBtn" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors">
                                    ‡¶∏‡¶¨ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®
                                </button>
                                <button id="deleteSelectedBtn" class="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                                    ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">
                                    <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('date')">
                                    ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶¶‡¶ø‡¶®
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('type')">
                                    ‡¶ß‡¶∞‡¶® <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortEntries('amount')">
                                    ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ‡¶®‡ßã‡¶ü
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">
                                    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®
                                </th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Entries will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav md:hidden">
            <div class="flex justify-around items-center py-2">
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('summary')">
                    <i class="fas fa-chart-bar text-lg"></i>
                    <span class="text-xs mt-1">‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('addEntry')">
                    <i class="fas fa-plus-circle text-lg"></i>
                    <span class="text-xs mt-1">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('entries')">
                    <i class="fas fa-list text-lg"></i>
                    <span class="text-xs mt-1">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</span>
                </button>
                <button class="flex flex-col items-center py-2 px-4 text-gray-600 dark:text-gray-300" onclick="scrollToSection('export')">
                    <i class="fas fa-download text-lg"></i>
                    <span class="text-xs mt-1">‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-buttons fixed right-6 bottom-24 md:bottom-6 z-20 no-print">
        <button id="fab" class="w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 transform hover:scale-110">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <!-- Modals -->
    <!-- Create Book Modal -->
    <div id="createBookModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 animate-slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="closeModal('createBookModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="createBookForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="newBookName" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ñ‡¶∞‡¶ö" required>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                        <button type="button" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors" onclick="closeModal('createBookModal')">
                            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Google Drive Auth Modal -->
    <div id="driveAuthModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 animate-slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Google Drive ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="closeModal('driveAuthModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="text-center">
                    <i class="fab fa-google-drive text-6xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">
                        ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ Google Drive ‡¶è ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Google ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                    </p>
                    
                    <button id="authorizeBtn" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors mb-3">
                        <i class="fab fa-google mr-2"></i>Google ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    
                    <button class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors" onclick="closeModal('driveAuthModal')">
                        ‡¶™‡¶∞‡ßá ‡¶ï‡¶∞‡¶¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 animate-slide-up">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                </div>
                
                <p class="text-gray-600 dark:text-gray-300 mb-6" id="confirmMessage">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?</p>
                
                <div class="flex gap-4">
                    <button id="confirmYes" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                        ‡¶π‡ßç‡¶Ø‡¶æ‡¶Å
                    </button>
                    <button id="confirmNo" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                        ‡¶®‡¶æ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Google Drive API Configuration
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
        const API_KEY = 'AIzaSyChqgFTfcoAaqte53R9y4PecwLIqKJwx_0';
        const CLIENT_ID = '406157098174-63ma0jc4t8h45g6svrm3abhrag948omo.apps.googleusercontent.com';
        
        // Global variables
        let currentBookId = null;
        let entries = [];
        let books = [];
        let editingEntryId = null;
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let gapi = window.gapi;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isAuthorized = false;
        let driveFileId = null;

        // Categories
        const categories = {
            income: ['‡¶¨‡ßá‡¶§‡¶®', '‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ', '‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', '‡¶â‡¶™‡¶π‡¶æ‡¶∞', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ü‡¶Ø‡¶º'],
            expense: ['‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø', '‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®', '‡¶¨‡¶ø‡¶®‡ßã‡¶¶‡¶®', '‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø', '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', '‡¶¨‡¶ø‡¶≤', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö']
        };

        // Days of week in Bengali
        const bengaliDays = ['‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadThemePreference();
            
            // Initialize Google APIs after DOM is loaded
            setTimeout(() => {
                initializeGoogleDrive();
            }, 1000);
        });

        function initializeApp() {
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                loadUserData();
                updateSummary();
                renderEntries();
            }, 1000);
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Entry form
            document.getElementById('entryForm').addEventListener('submit', handleAddEntry);
            document.getElementById('entryType').addEventListener('change', updateCategoryOptions);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
            
            // Book management
            document.getElementById('createBookBtn').addEventListener('click', () => openModal('createBookModal'));
            document.getElementById('deleteBookBtn').addEventListener('click', deleteCurrentBook);
            document.getElementById('currentBook').addEventListener('change', switchBook);
            document.getElementById('createBookForm').addEventListener('submit', handleCreateBook);
            
            // Filters
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('searchBox').addEventListener('input', applyFilters);
            
            // Export buttons
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
            
            // Google Drive sync
            document.getElementById('syncBtn').addEventListener('click', handleSync);
            document.getElementById('authorizeBtn').addEventListener('click', handleAuthClick);
            
            // Table actions
            document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAll);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedEntries);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            
            // Floating action button
            document.getElementById('fab').addEventListener('click', () => {
                document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('entryAmount').focus();
            });
            
            // Confirmation modal
            document.getElementById('confirmYes').addEventListener('click', confirmAction);
            document.getElementById('confirmNo').addEventListener('click', () => closeModal('confirmModal'));
            
            // Set default date
            document.getElementById('entryDate').valueAsDate = new Date();
        }

        // Safe localStorage operations
        function safeGetLocalStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error(`Error reading from localStorage (${key}):`, error);
                return defaultValue;
            }
        }

        function safeSetLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.error(`Error writing to localStorage (${key}):`, error);
                showToast('‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
                return false;
            }
        }

        function safeGetStringFromLocalStorage(key, defaultValue = null) {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (error) {
                console.error(`Error reading string from localStorage (${key}):`, error);
                return defaultValue;
            }
        }

        function safeSetStringToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.error(`Error writing string to localStorage (${key}):`, error);
                return false;
            }
        }

        // Google Drive API Functions
        function initializeGoogleDrive() {
            console.log('Initializing Google Drive APIs...');
            
            // Initialize GAPI client
            if (typeof gapi !== 'undefined' && gapi.load) {
                gapi.load('client', initializeGapiClient);
            } else {
                console.error('GAPI not loaded');
                updateSyncStatus('error', 'API ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø');
            }
            
            // Initialize Google Identity Services
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    // Initialize token client
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: handleTokenResponse,
                    });
                    gisInited = true;
                    console.log('Google Identity Services initialized');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('Error initializing Google Identity Services:', error);
                    updateSyncStatus('error', '‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
                }
            } else {
                console.error('Google Identity Services not loaded');
                updateSyncStatus('error', 'Google API ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø');
            }
        }

        async function initializeGapiClient() {
            try {
                console.log('Initializing GAPI client...');
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                console.log('GAPI client initialized successfully');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI client:', error);
                updateSyncStatus('error', '‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
                showToast('Google API ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            }
        }

        function maybeEnableButtons() {
            console.log('Checking API initialization status:', { gapiInited, gisInited });
            
            if (gapiInited && gisInited) {
                // Check if already authorized
                const token = safeGetStringFromLocalStorage('google_access_token');
                if (token) {
                    try {
                        gapi.client.setToken({ access_token: token });
                        isAuthorized = true;
                        updateSyncStatus('synced', '‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§');
                        console.log('Using stored access token');
                        loadFromDrive();
                    } catch (error) {
                        console.error('Error setting stored token:', error);
                        safeSetStringToLocalStorage('google_access_token', null);
                        updateSyncStatus('offline', '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®');
                    }
                } else {
                    updateSyncStatus('offline', '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®');
                }
            } else {
                updateSyncStatus('error', 'API ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø');
            }
        }

        function handleAuthClick() {
            console.log('Auth button clicked');
            
            if (!tokenClient) {
                showToast('Google ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶®‡¶Ø‡¶º', 'error');
                return;
            }

            try {
                // Request access token
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } catch (error) {
                console.error('Error requesting access token:', error);
                showToast('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            }
        }

        function handleTokenResponse(response) {
            console.log('Token response received:', response);
            
            if (response.error) {
                console.error('Auth error:', response.error);
                showToast('Google ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
                return;
            }

            if (response.access_token) {
                try {
                    // Try to save token with error handling
                    const tokenSaved = safeSetStringToLocalStorage('google_access_token', response.access_token);
                    
                    if (!tokenSaved) {
                        showToast('‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ, ‡¶§‡¶¨‡ßá ‡¶∏‡ßá‡¶∂‡¶®‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá', 'warning');
                    }

                    if (!gapi || !gapi.client) {
  showToast('Google API ‡¶è‡¶ñ‡¶®‡¶ì ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø', 'error');
  return;
}
                    
                    gapi.client.setToken(response);
                    isAuthorized = true;
                    closeModal('driveAuthModal');
                    updateSyncStatus('synced', '‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§');
                    showToast('Google Drive ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                    
                    // Initial sync
                    setTimeout(() => {
                        syncToDrive();
                    }, 1000);
                } catch (error) {
                    console.error('Error handling token response:', error);
                    showToast('‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
                    
                    // Try to continue with temporary authorization
                    try {
                        gapi.client.setToken(response);
                        isAuthorized = true;
                        closeModal('driveAuthModal');
                        updateSyncStatus('synced', '‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ (‡¶Ö‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ)');
                        showToast('Google Drive ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ö‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶ø‡¶§', 'info');
                    } catch (secondaryError) {
                        console.error('Secondary error in token handling:', secondaryError);
                        showToast('‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•', 'error');
                    }
                }
            }
        }

        async function handleSync() {
            if (!isAuthorized) {
                openModal('driveAuthModal');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
                await syncToDrive();
                await loadFromDrive();
                updateSyncStatus('synced', '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£');
                showToast('‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
                showToast('‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + (error.message || error.result?.error?.message || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø'), 'error');
            }
        }

        async function syncToDrive() {
            if (!isAuthorized) {
                console.log('Not authorized for sync');
                return;
            }
            
            console.log('Starting sync to Drive...');
            
            try {
                const data = {
                    books: books,
                    entries: entries,
                    currentBookId: currentBookId,
                    lastSync: new Date().toISOString()
                };
                
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                
                const metadata = {
                    'name': 'cashbook-data.json',
                    'parents': ['appDataFolder']
                };
                
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(data) +
                    close_delim;
                
                const request = gapi.client.request({
                    'path': driveFileId ? `/upload/drive/v3/files/${driveFileId}` : '/upload/drive/v3/files',
                    'method': driveFileId ? 'PATCH' : 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    'body': multipartRequestBody
                });
                
                const response = await request;
                console.log('Sync response:', response);
                
                if (response.result && response.result.id) {
                    driveFileId = response.result.id;
                    safeSetStringToLocalStorage('drive_file_id', driveFileId);
                    console.log('File synced successfully with ID:', driveFileId);
                }
            } catch (error) {
                console.error('Error syncing to Drive:', error);
                throw error;
            }
        }

        async function loadFromDrive() {
            if (!isAuthorized) {
                console.log('Not authorized for loading from Drive');
                return;
            }
            
            try {
                console.log('Loading from Drive...');
                
                // First, find the file
                const searchResponse = await gapi.client.drive.files.list({
                    q: "name='cashbook-data.json' and parents in 'appDataFolder'",
                    spaces: 'appDataFolder'
                });
                
                console.log('Search response:', searchResponse);
                
                if (searchResponse.result.files.length > 0) {
                    driveFileId = searchResponse.result.files[0].id;
                    safeSetStringToLocalStorage('drive_file_id', driveFileId);
                    
                    // Download the file
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });
                    
                    console.log('File response:', fileResponse);
                    
                    if (fileResponse.body) {
                        const data = JSON.parse(fileResponse.body);
                        
                        // Check if cloud data is newer
                        const localLastSync = safeGetStringFromLocalStorage('last_sync');
                        if (!localLastSync || new Date(data.lastSync) > new Date(localLastSync)) {
                            books = data.books || [];
                            entries = data.entries || [];
                            currentBookId = data.currentBookId || null;
                            
                            safeSetStringToLocalStorage('last_sync', data.lastSync);
                            saveUserData();
                            updateBookSelector();
                            updateSummary();
                            renderEntries();
                            
                            showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                            console.log('Data loaded from cloud successfully');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading from Drive:', error);
                // Don't show error to user as this might be first time
            }
        }

        function updateSyncStatus(status, text) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.className = `sync-status ${status}`;
            
            const icons = {
                synced: 'fa-cloud-check',
                syncing: 'fa-sync-alt fa-spin',
                error: 'fa-cloud-exclamation',
                offline: 'fa-cloud-off'
            };
            
            syncStatus.innerHTML = `
                <i class="fas ${icons[status]}"></i>
                <span>${text}</span>
            `;
        }

        function loadUserData() {
            const userData = safeGetLocalStorage('cashbook_data');
            if (userData) {
                books = userData.books || [];
                entries = userData.entries || [];
                currentBookId = userData.currentBookId || null;
            } else {
                // Create default book
                books = [{ id: Date.now().toString(), name: '‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡¶á', createdAt: new Date().toISOString() }];
                currentBookId = books[0].id;
                entries = [];
                saveUserData();
            }
            
            updateBookSelector();
            
            // Try to load from Drive if authorized
            if (isAuthorized) {
                loadFromDrive();
            }
        }

        function saveUserData() {
            const data = {
                books: books,
                entries: entries,
                currentBookId: currentBookId
            };
            
            const saved = safeSetLocalStorage('cashbook_data', data);
            
            // Auto-sync to Drive if authorized
            if (isAuthorized && saved) {
                syncToDrive().catch(console.error);
            }
        }

        function updateBookSelector() {
            const selector = document.getElementById('currentBook');
            selector.innerHTML = '<option value="">‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                if (book.id === currentBookId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            updateCategoryOptions();
        }

        function switchBook() {
            const newBookId = document.getElementById('currentBook').value;
            if (newBookId !== currentBookId) {
                currentBookId = newBookId;
                saveUserData();
                updateSummary();
                renderEntries();
                showToast('‡¶¨‡¶á ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            }
        }

        function handleCreateBook(e) {
            e.preventDefault();
            
            const bookName = document.getElementById('newBookName').value.trim();
            if (!bookName) {
                showToast('‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error');
                return;
            }
            
            const newBook = {
                id: Date.now().toString(),
                name: bookName,
                createdAt: new Date().toISOString()
            };
            
            books.push(newBook);
            currentBookId = newBook.id;
            saveUserData();
            updateBookSelector();
            closeModal('createBookModal');
            
            showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            
            document.getElementById('newBookName').value = '';
        }

        function deleteCurrentBook() {
            if (!currentBookId) {
                showToast('‡¶ï‡ßã‡¶® ‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º', 'error');
                return;
            }
            
            if (books.length <= 1) {
                showToast('‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶á ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
                return;
            }
            
            const currentBook = books.find(b => b.id === currentBookId);
            showConfirmModal(
                `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${currentBook.name}" ‡¶¨‡¶á‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶§‡ßá ‡¶∏‡¶¨ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`,
                () => {
                    // Remove book and its entries
                    books = books.filter(b => b.id !== currentBookId);
                    entries = entries.filter(e => e.bookId !== currentBookId);
                    
                    // Switch to first available book
                    currentBookId = books[0].id;
                    
                    saveUserData();
                    updateBookSelector();
                    updateSummary();
                    renderEntries();
                    
                    showToast('‡¶¨‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                }
            );
        }

        function updateCategoryOptions() {
            const typeSelect = document.getElementById('entryType');
            const categorySelect = document.getElementById('entryCategory');
            const filterCategorySelect = document.getElementById('filterCategory');
            
            const selectedType = typeSelect.value;
            
            // Clear and populate category options
            categorySelect.innerHTML = '<option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            filterCategorySelect.innerHTML = '<option value="">‡¶∏‡¶¨</option>';
            
            if (selectedType && categories[selectedType]) {
                categories[selectedType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                    
                    const filterOption = option.cloneNode(true);
                    filterCategorySelect.appendChild(filterOption);
                });
            }
        }

        function handleAddEntry(e) {
            e.preventDefault();
            
            if (!currentBookId) {
                showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }
            
            const formData = {
                date: document.getElementById('entryDate').value,
                type: document.getElementById('entryType').value,
                amount: parseFloat(document.getElementById('entryAmount').value),
                category: document.getElementById('entryCategory').value,
                note: document.getElementById('entryNote').value.trim()
            };
            
            // Validation
            if (!formData.date || !formData.type || !formData.amount || !formData.category) {
                showToast('‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }
            
            if (formData.amount <= 0) {
                showToast('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß¶ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
                return;
            }
            
            const entry = {
                id: editingEntryId || Date.now().toString(),
                bookId: currentBookId,
                date: formData.date,
                type: formData.type,
                amount: formData.amount,
                category: formData.category,
                note: formData.note,
                createdAt: editingEntryId ? entries.find(e => e.id === editingEntryId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingEntryId) {
                // Update existing entry
                const index = entries.findIndex(e => e.id === editingEntryId);
                entries[index] = entry;
                showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                cancelEdit();
            } else {
                // Add new entry
                entries.push(entry);
                showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            }
            
            saveUserData();
            updateSummary();
            renderEntries();
            
            // Reset form
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
        }

        function editEntry(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;
            
            editingEntryId = entryId;
            
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryType').value = entry.type;
            document.getElementById('entryAmount').value = entry.amount;
            document.getElementById('entryNote').value = entry.note;
            
            // Update category options and set selected
            updateCategoryOptions();
            setTimeout(() => {
                document.getElementById('entryCategory').value = entry.category;
            }, 100);
            
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth' });
            
            showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡ßá', 'info');
        }

        function cancelEdit() {
            editingEntryId = null;
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            updateCategoryOptions();
        }

        function deleteEntry(entryId) {
            showConfirmModal(
                '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
                () => {
                    entries = entries.filter(e => e.id !== entryId);
                    saveUserData();
                    updateSummary();
                    renderEntries();
                    showToast('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                }
            );
        }

        function getCurrentBookEntries() {
            return entries.filter(e => e.bookId === currentBookId);
        }

        function updateSummary() {
            const bookEntries = getCurrentBookEntries();
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            bookEntries.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            const totalEntries = bookEntries.length;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('currentBalance').textContent = formatCurrency(balance);
            document.getElementById('totalEntries').textContent = totalEntries.toString();
            
            // Update balance color
            const balanceElement = document.getElementById('currentBalance');
            const balanceCard = balanceElement.closest('.bg-gradient-to-r');
            
            if (balance > 0) {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-green-400 to-green-600');
            } else if (balance < 0) {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-red-400 to-red-600');
            } else {
                balanceCard.className = balanceCard.className.replace(/from-\w+-\d+ to-\w+-\d+/, 'from-blue-400 to-blue-600');
            }
        }

        function renderEntries() {
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            const sortedEntries = sortEntriesList(filteredEntries, sortColumn, sortDirection);‡¶∞
            
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';
            
            if (sortedEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            <p class="text-lg">‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>
                            <p class="text-sm">‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </td>
                    </tr>
                `;
                document.getElementById('entriesCount').textContent = '‡ß¶‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø';
                return;
            }
            
            sortedEntries.forEach(entry => {
                const date = new Date(entry.date);
                const dayName = bengaliDays[date.getDay()];
                const typeClass = entry.type === 'income' ? 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300' : 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300';
                
                const row = document.createElement('tr');
                row.className = 'entry-row hover:bg-gray-50 dark:hover:bg-gray-700 relative';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap no-print">
                        <input type="checkbox" class="entry-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" data-entry-id="${entry.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        ${formatDate(entry.date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${dayName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeClass}">
                            <i class="fas fa-${entry.type === 'income' ? 'arrow-up' : 'arrow-down'} mr-1"></i>
                            ${entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${entry.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                        ${formatCurrency(entry.amount)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        ${entry.category}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate" title="${entry.note}">
                        ${entry.note || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium no-print">
                        <div class="flex space-x-2">
                            <button onclick="editEntry('${entry.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEntry('${entry.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('entriesCount').textContent = `${sortedEntries.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø`;
        }

        function applyCurrentFilters(entries) {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const category = document.getElementById('filterCategory').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            return entries.filter(entry => {
                if (startDate && entry.date < startDate) return false;
                if (endDate && entry.date > endDate) return false;
                if (type && entry.type !== type) return false;
                if (category && entry.category !== category) return false;
                if (searchTerm && !entry.note.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
        }

        function applyFilters() {
            renderEntries();
        }

        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('searchBox').value = '';
            applyFilters();
        }

        function sortEntriesList(entries, column, direction) {
            return [...entries].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (column === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else if (column === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        window.sortEntries = function(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderEntries();
        };

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const entryCheckboxes = document.querySelectorAll('.entry-checkbox');
            
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function deleteSelectedEntries() {
            const selectedCheckboxes = document.querySelectorAll('.entry-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º', 'warning');
                return;
            }
            
            showConfirmModal(
                `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${selectedCheckboxes.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`,
                () => {
                    const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.entryId);
                    entries = entries.filter(entry => !idsToDelete.includes(entry.id));
                    
                    saveUserData();
                    updateSummary();
                    renderEntries();
                    
                    showToast(`${selectedCheckboxes.length}‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                }
            );
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredEntries.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else {
                    totalExpense += entry.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // Add content to PDF
            doc.setFontSize(20);
            doc.text('‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßÅ‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD')}`, 20, 35);
            
            // Summary
            doc.setFontSize(16);
            doc.text('‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂:', 20, 55);
            
            doc.setFontSize(12);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º: ${formatCurrency(totalIncome)}`, 20, 70);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: ${formatCurrency(totalExpense)}`, 20, 80);
            doc.text(`‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${formatCurrency(balance)}`, 20, 90);
            doc.text(`‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø: ${filteredEntries.length}`, 20, 100);
            
            // Entries table
            if (filteredEntries.length > 0) {
                doc.setFontSize(16);
                doc.text('‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:', 20, 120);
                
                let yPos = 135;
                doc.setFontSize(10);
                
                // Table header
                doc.text('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', 20, yPos);
                doc.text('‡¶ß‡¶∞‡¶®', 60, yPos);
                doc.text('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£', 100, yPos);
                doc.text('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø', 140, yPos);
                doc.text('‡¶®‡ßã‡¶ü', 180, yPos);
                
                yPos += 10;
                
                filteredEntries.forEach(entry => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(formatDate(entry.date), 20, yPos);
                    doc.text(entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö', 60, yPos);
                    doc.text(formatCurrency(entry.amount), 100, yPos);
                    doc.text(entry.category, 140, yPos);
                    doc.text(entry.note || '-', 180, yPos);
                    
                    yPos += 8;
                });
            }
            
            doc.save(`cashbook-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function exportToCSV() {
            const bookEntries = getCurrentBookEntries();
            const filteredEntries = applyCurrentFilters(bookEntries);
            
            if (filteredEntries.length === 0) {
                showToast('‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á', 'warning');
                return;
            }
            
            const headers = ['‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ', '‡¶ß‡¶∞‡¶®', '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£', '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø', '‡¶®‡ßã‡¶ü'];
            const csvContent = [
                headers.join(','),
                ...filteredEntries.map(entry => [
                    entry.date,
                    entry.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶ñ‡¶∞‡¶ö',
                    entry.amount,
                    entry.category,
                    `"${entry.note || ''}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, `cashbook-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showToast('CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Theme management
        function loadThemePreference() {
            const savedTheme = safeGetStringFromLocalStorage('cashbook_theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            safeSetStringToLocalStorage('cashbook_theme', isDark ? 'dark' : 'light');
            showToast(`${isDark ? '‡¶°‡¶æ‡¶∞‡ßç‡¶ï' : '‡¶≤‡¶æ‡¶á‡¶ü'} ‡¶•‡¶ø‡¶Æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'info');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmYes').onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        }

        function confirmAction() {
            // This will be overridden by showConfirmModal
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${getToastIcon(type)} mr-2"></i>
                ${message}
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Mobile navigation
        function scrollToSection(section) {
            const sections = {
                summary: document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4'),
                addEntry: document.getElementById('entryForm'),
                entries: document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.shadow-lg.overflow-hidden'),
                export: document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.shadow-lg.p-6.mb-8.no-print')
            };
            
            if (sections[section]) {
                sections[section].scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('bn-BD', {
                style: 'currency',
                currency: 'BDT',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount).replace('‡ß≥', '') + ' ‡ß≥';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('bn-BD', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Auto-save functionality
        setInterval(() => {
            if (currentBookId) {
                saveUserData();
            }
        }, 30000); // Auto-save every 30 seconds

        // Auto-sync functionality
        setInterval(() => {
            if (isAuthorized && currentBookId) {
                syncToDrive().catch(console.error);
            }
        }, 300000); // Auto-sync every 5 minutes
    </script>
</body>
</html>
