<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Cashbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">💰 My Cashbook</h1>

    <!-- Summary Section -->
    <div class="bg-white p-4 rounded shadow mb-4">
      <h2 class="text-xl font-semibold mb-2">📈 Summary</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>Total Income: <span id="summaryIncome">0</span> ৳</div>
        <div>Total Expense: <span id="summaryExpense">0</span> ৳</div>
        <div>Balance: <span id="summaryBalance">0</span> ৳</div>
        <div>Total Entries: <span id="summaryCount">0</span></div>
      </div>
    </div>

    <!-- Book Selector -->
    <div class="mb-4">
      <label class="block mb-1 font-semibold">Select or Create Book</label>
      <div class="flex gap-2">
        <select id="bookSelector" class="flex-1 p-2 border rounded"></select>
        <input id="newBookName" placeholder="New Book Name" class="p-2 border rounded">
        <button onclick="createBook()" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
      </div>
    </div>

    <!-- Entry Form -->
    <div class="bg-white p-4 rounded shadow mb-4">
      <h2 class="text-xl font-semibold mb-2">Add Entry</h2>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-2">
        <input id="entryDate" type="date" class="p-2 border rounded">
        <select id="entryType" class="p-2 border rounded">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
        <input id="entryAmount" type="number" placeholder="Amount" class="p-2 border rounded">
        <input id="entryCategory" type="text" placeholder="Category" class="p-2 border rounded">
        <input id="entryNote" type="text" placeholder="Note" class="p-2 border rounded">
        <button onclick="addEntry()" class="bg-green-600 text-white px-4 py-2 rounded">Add</button>
      </div>
    </div>

    <!-- Filter & Download -->
    <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
      <div class="flex gap-2 items-center">
        <label class="font-semibold">From:</label>
        <input id="filterStartDate" type="date" class="p-2 border rounded">
        <label class="font-semibold">To:</label>
        <input id="filterEndDate" type="date" class="p-2 border rounded">
        <input id="filterSearch" placeholder="Search note/category" class="p-2 border rounded">
        <button onclick="renderEntries()" class="bg-blue-500 text-white px-3 py-1 rounded">Filter</button>
      </div>
      <div class="flex gap-2">
        <button onclick="downloadData()" class="bg-purple-600 text-white px-4 py-2 rounded">Download</button>
        <button onclick="backupToDrive()" class="bg-yellow-500 text-white px-4 py-2 rounded">Backup</button>
        <button onclick="restoreFromDrive()" class="bg-orange-500 text-white px-4 py-2 rounded">Restore</button>
      </div>
    </div>

    
    <div class="my-4">
      <button onclick="handleAuthClick()" class="bg-blue-700 text-white px-4 py-2 rounded">
        Sign in with Google
      </button>
      <button onclick="handleSignoutClick()" class="bg-gray-600 text-white px-4 py-2 rounded ml-2">
        Sign out
      </button>
    </div>


<!-- Entry Table -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-2">Entries</h2>
      <table class="w-full table-auto text-sm">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 text-left">Date</th>
            <th class="p-2 text-left">Day</th>
            <th class="p-2 text-left">Type</th>
            <th class="p-2 text-left">Amount</th>
            <th class="p-2 text-left">Category</th>
            <th class="p-2 text-left">Note</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="entryTable"></tbody>
      </table>
    </div>
  </div>

  <script>

    const CLIENT_ID = '406157098174-63ma0jc4t8h45g6svrm3abhrag948omo.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let books = JSON.parse(localStorage.getItem('books')) || {};
    let currentBook = null;

    function loadBooks() {
      const bookSelector = document.getElementById('bookSelector');
      bookSelector.innerHTML = '';
      Object.keys(books).forEach(book => {
        const opt = document.createElement('option');
        opt.value = book;
        opt.textContent = book;
        bookSelector.appendChild(opt);
      });
      if (!currentBook && Object.keys(books).length > 0) {
        currentBook = Object.keys(books)[0];
        bookSelector.value = currentBook;
        renderEntries();
      }
    }

    function createBook() {
      const name = document.getElementById('newBookName').value.trim();
      if (name && !books[name]) {
        books[name] = [];
        currentBook = name;
        await saveAndSync();
        loadBooks();
        renderEntries();
      }
    }

    function saveBooks() {
      localStorage.setItem('books', JSON.stringify(books));
    }

    function addEntry() {
      const date = document.getElementById('entryDate').value;
      const type = document.getElementById('entryType').value;
      const amount = parseFloat(document.getElementById('entryAmount').value);
      const note = document.getElementById('entryNote').value;
      const category = document.getElementById('entryCategory').value;
      if (!date || !type || isNaN(amount)) return;
      books[currentBook].push({ date, type, amount, note, category });
      await saveAndSync();
      renderEntries();
    }

    function editEntry(index) {
      const entry = books[currentBook][index];
      document.getElementById('entryDate').value = entry.date;
      document.getElementById('entryType').value = entry.type;
      document.getElementById('entryAmount').value = entry.amount;
      document.getElementById('entryNote').value = entry.note;
      document.getElementById('entryCategory').value = entry.category || '';
      books[currentBook].splice(index, 1);
      await saveAndSync();
      renderEntries();
    }

    function getDayOfWeek(dateStr) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      return days[new Date(dateStr).getDay()];
    }

    function renderEntries() {
      const table = document.getElementById('entryTable');
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      const search = document.getElementById('filterSearch').value.toLowerCase();
      table.innerHTML = '';
      let balance = 0, income = 0, expense = 0, count = 0;

      books[currentBook].forEach((entry, index) => {
        if ((startDate && entry.date < startDate) || (endDate && entry.date > endDate)) return;
        if (search && !(entry.note?.toLowerCase().includes(search) || entry.category?.toLowerCase().includes(search))) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${entry.date}</td>
          <td class="p-2">${getDayOfWeek(entry.date)}</td>
          <td class="p-2 capitalize">${entry.type}</td>
          <td class="p-2">${entry.amount}</td>
          <td class="p-2">${entry.category || ''}</td>
          <td class="p-2">${entry.note}</td>
          <td class="p-2">
            <button onclick="editEntry(${index})" class="text-blue-600 hover:underline">Edit</button>
          </td>
        `;
        table.appendChild(tr);
        count++;
        if (entry.type === 'income') income += entry.amount;
        else expense += entry.amount;
      });
      balance = income - expense;
      document.getElementById('summaryIncome').textContent = income;
      document.getElementById('summaryExpense').textContent = expense;
      document.getElementById('summaryBalance').textContent = balance;
      document.getElementById('summaryCount').textContent = count;
    }

    function downloadData() {
      const data = books[currentBook];
      const csv = ["Date,Day,Type,Amount,Category,Note"];
      data.forEach(entry => {
        const day = getDayOfWeek(entry.date);
        csv.push(`${entry.date},${day},${entry.type},${entry.amount},${entry.category || ''},${entry.note}`);
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentBook}_cashbook.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    async function backupToDrive() {
      const content = JSON.stringify(books[currentBook], null, 2);
      const file = new Blob([content], { type: 'application/json' });
      const metadata = {
        name: `${currentBook}_backup.json`,
        mimeType: 'application/json'
      };
      const accessToken = gapi.auth.getToken().access_token;
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);
      try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });
        const result = await response.json();
        alert('✅ Backup successful! File ID: ' + result.id);
      } catch (error) {
        console.error('Backup failed', error);
        alert('❌ Backup failed.');
      }
    }

    async function restoreFromDrive() {
      const accessToken = gapi.auth.getToken().access_token;
      try {
        const response = await fetch('https://www.googleapis.com/drive/v3/files?q=name contains \'_backup.json\'&fields=files(id,name)&spaces=drive', {
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
        });
        const data = await response.json();
        if (!data.files.length) return alert('No backup files found.');
        const fileId = data.files[0].id;
        const contentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
        });
        const json = await contentRes.json();
        books[currentBook] = json;
        await saveAndSync();
        renderEntries();
        alert('✅ Restore complete.');
      } catch (error) {
        console.error('Restore failed', error);
        alert('❌ Restore failed.');
      }
    }

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: 'AIzaSyChqgFTfcoAaqte53R9y4PecwLIqKJwx_0',
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      gapiInited = true;
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // will be set later
      });
      gisInited = true;
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) throw resp;
        alert('Login successful!');
      };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        alert('Logged out.');
      }
    }

    
    async function autoSync() {
      if (gapi.client.getToken()) {
        await restoreFromDrive();
      }
    }

    async function saveAndSync() {
      saveBooks();
      if (gapi.client.getToken()) {
        await backupToDrive();
      }
    }


    document.getElementById('bookSelector').addEventListener('change', function () {
      currentBook = this.value;
      renderEntries();
    });

    window.onload = async () => {
      await autoSync();
      gapiLoaded();
      gisLoaded();
      loadBooks();
    };

</script>
</body>
</html>
